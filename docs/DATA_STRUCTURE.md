# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: –°–º–µ–Ω–∞ –∏ –¢–∞–±–µ–ª—å

## üìã –û–±–∑–æ—Ä

–í —Å–∏—Å—Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–¥–≤–∞ —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ Bitrix24** –∏ **–ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

## üîÑ –°–º–µ–Ω–∞ (Shift)

### –ß—Ç–æ —ç—Ç–æ?
**–°–º–µ–Ω–∞** ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞ –æ–±—ä–µ–∫—Ç–µ. –û–Ω–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç:
- –ü–ª–∞–Ω —Ä–∞–±–æ—Ç –Ω–∞ –¥–µ–Ω—å
- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã
- –†–µ—Å—É—Ä—Å—ã (—Ç–µ—Ö–Ω–∏–∫–∞ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã)
- –¢–∞–±–µ–ª–∏ (—É—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ—Å—Ç–æ–µ–≤ –∏ —Ñ–æ—Ç–æ

### –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è?

#### 1. **Bitrix24** (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
- **Entity Type ID**: `1050`
- **–°–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å**: "–°–º–µ–Ω–∞"
- **–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: `app/services/bitrix_ids.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ Bitrix24:**
- `UF_DATE` ‚Äî –î–∞—Ç–∞ —Å–º–µ–Ω—ã
- `UF_TYPE` ‚Äî –¢–∏–ø —Å–º–µ–Ω—ã (–¥–µ–Ω—å/–Ω–æ—á—å)
- `UF_OBJECT_LINK` ‚Äî –°–≤—è–∑—å —Å –æ–±—ä–µ–∫—Ç–æ–º
- `UF_PLAN_TOTAL` ‚Äî –ü–ª–∞–Ω–æ–≤—ã–π –æ–±—ä—ë–º —Ä–∞–±–æ—Ç
- `UF_FACT_TOTAL` ‚Äî –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–±—ä—ë–º —Ä–∞–±–æ—Ç
- `UF_EFF_RAW` ‚Äî –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `UF_EFF_FINAL` ‚Äî –ò—Ç–æ–≥–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- `UF_STATUS` ‚Äî –°—Ç–∞—Ç—É—Å (open/closed)
- `UF_DOWNTIME_REASON` ‚Äî –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç)
- `UF_SHIFT_PHOTOS` ‚Äî –§–æ—Ç–æ —Å–º–µ–Ω—ã (—Ñ–∞–π–ª—ã, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ)

#### 2. **–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î SQLite** (–∫—ç—à –∏ —Ä–µ–∑–µ—Ä–≤)
- **–¢–∞–±–ª–∏—Ü–∞**: `shifts`
- **–§–∞–π–ª –ë–î**: `gpo_assistant.db` (–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
- **–ú–æ–¥–µ–ª—å**: `app/models.py` ‚Üí `class Shift`

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î:**
- `id` ‚Äî –õ–æ–∫–∞–ª—å–Ω—ã–π ID —Å–º–µ–Ω—ã
- `object_id` ‚Äî ID –æ–±—ä–µ–∫—Ç–∞ (FK)
- `date` ‚Äî –î–∞—Ç–∞ —Å–º–µ–Ω—ã
- `type` ‚Äî –¢–∏–ø —Å–º–µ–Ω—ã (DAY/NIGHT)
- `plan_json` ‚Äî –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (JSON)
- `fact_json` ‚Äî –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã (JSON)
- `eff_raw`, `eff_final` ‚Äî –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- `status` ‚Äî –°—Ç–∞—Ç—É—Å (OPEN/CLOSED)
- `bitrix_id` ‚Äî **ID —Å–º–µ–Ω—ã –≤ Bitrix24** (—Å–≤—è–∑—å —Å Bitrix24)
- `uf_downtime_reason` ‚Äî –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è
- `created_by` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–≤—à–µ–≥–æ —Å–º–µ–Ω—É

### –ó–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç?
- ‚úÖ **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç** –Ω–∞ –¥–µ–Ω—å
- ‚úÖ **–£—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç** (–ø–ª–∞–Ω-—Ñ–∞–∫—Ç)
- ‚úÖ **–†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ **–£—á–µ—Ç –ø—Ä–æ—Å—Ç–æ–µ–≤** –∏ –∏—Ö –ø—Ä–∏—á–∏–Ω
- ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ** —Å–º–µ–Ω—ã
- ‚úÖ **–°–≤—è–∑—å —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏** (—Ç–µ—Ö–Ω–∏–∫–∞/–º–∞—Ç–µ—Ä–∏–∞–ª—ã)
- ‚úÖ **–°–≤—è–∑—å —Å —Ç–∞–±–µ–ª—è–º–∏** (—É—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)

---

## üë• –¢–∞–±–µ–ª—å (Timesheet)

### –ß—Ç–æ —ç—Ç–æ?
**–¢–∞–±–µ–ª—å** ‚Äî —ç—Ç–æ —É—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±—Ä–∏–≥–∞–¥/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Å–º–µ–Ω–µ. –ö–∞–∂–¥—ã–π —Ç–∞–±–µ–ª—å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–º–µ–Ω–µ.

### –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è?

#### 1. **Bitrix24** (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
- **Entity Type ID**: `1060`
- **–°–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å**: "–¢–∞–±–µ–ª—å"
- **–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: `bitrix_field_map.json`

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ Bitrix24:**
- `UF_SHIFT_ID` ‚Äî ID —Å–º–µ–Ω—ã (—Å–≤—è–∑–∫–∞ –Ω–∞ "–°–º–µ–Ω–∞")
- `UF_WORKER` ‚Äî –°–æ—Ç—Ä—É–¥–Ω–∏–∫/–±—Ä–∏–≥–∞–¥–∞ (—Ç–µ–∫—Å—Ç)
- `UF_HOURS` ‚Äî –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã (—á–∏—Å–ª–æ)
- `UF_RATE` ‚Äî –°—Ç–∞–≤–∫–∞ –≤ —Ä—É–±–ª—è—Ö (—á–∏—Å–ª–æ)
- `UF_TS_COMMENT` ‚Äî –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–∞–±–µ–ª—é (—Ç–µ–∫—Å—Ç)
- `UF_TS_PHOTOS` ‚Äî –§–æ—Ç–æ —Ç–∞–±–µ–ª—è (—Ñ–∞–π–ª—ã, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ)

#### 2. **–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î SQLite** (–∫—ç—à –∏ —Ä–µ–∑–µ—Ä–≤)
- **–¢–∞–±–ª–∏—Ü–∞**: `timesheets`
- **–§–∞–π–ª –ë–î**: `gpo_assistant.db` (–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
- **–ú–æ–¥–µ–ª—å**: `app/models.py` ‚Üí `class Timesheet`

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î:**
- `id` ‚Äî –õ–æ–∫–∞–ª—å–Ω—ã–π ID —Ç–∞–±–µ–ª—è
- `shift_id` ‚Äî ID —Å–º–µ–Ω—ã (FK)
- `crew` ‚Äî –ë—Ä–∏–≥–∞–¥–∞/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫
- `hours` ‚Äî –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã
- `rate` ‚Äî –°—Ç–∞–≤–∫–∞ –≤ —Ä—É–±–ª—è—Ö

### –ó–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç?
- ‚úÖ **–£—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏** –±—Ä–∏–≥–∞–¥/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- ‚úÖ **–†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã** (—á–∞—Å—ã √ó —Å—Ç–∞–≤–∫–∞)
- ‚úÖ **–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–º–µ–Ω–µ** (–∫–∞–∫–æ–π —Ç–∞–±–µ–ª—å –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∫–∞–∫–æ–π —Å–º–µ–Ω–µ)
- ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤** –∏ —Ñ–æ—Ç–æ —Ç–∞–±–µ–ª—è

---

## üîó –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏

```
–û–±—ä–µ–∫—Ç (1046)
    ‚Üì
–°–º–µ–Ω–∞ (1050) ‚Üê‚îÄ‚îÄ‚îÄ –†–µ—Å—É—Ä—Å (1056) [—Ç–µ—Ö–Ω–∏–∫–∞/–º–∞—Ç–µ—Ä–∏–∞–ª—ã]
    ‚Üì
–¢–∞–±–µ–ª—å (1060) [—É—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏]
```

- **–û–¥–∏–Ω –æ–±—ä–µ–∫—Ç** ‚Üí **–º–Ω–æ–≥–æ —Å–º–µ–Ω**
- **–û–¥–Ω–∞ —Å–º–µ–Ω–∞** ‚Üí **–º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤** (—Ç–µ—Ö–Ω–∏–∫–∞/–º–∞—Ç–µ—Ä–∏–∞–ª—ã)
- **–û–¥–Ω–∞ —Å–º–µ–Ω–∞** ‚Üí **–º–Ω–æ–≥–æ —Ç–∞–±–µ–ª–µ–π** (–±—Ä–∏–≥–∞–¥—ã/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)

---

## üìä –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö?

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î (SQLite)
- **–ü—É—Ç—å**: `C:\–ì–ü–û –ü–æ–º–æ—â–Ω–∏–∫\gpo_assistant.db`
- **–¢–∏–ø**: SQLite (—Ñ–∞–π–ª–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö—ç—à, —Ä–µ–∑–µ—Ä–≤, –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å Bitrix24

### Bitrix24 (–æ–±–ª–∞–∫–æ)
- **–¢–∏–ø**: –û–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Bitrix24
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- **–î–æ—Å—Ç—É–ø**: –ß–µ—Ä–µ–∑ REST API (`BITRIX_WEBHOOK_URL`)
- **Entity Type IDs**:
  - –û–±—ä–µ–∫—Ç: `1046`
  - –°–º–µ–Ω–∞: `1050`
  - –†–µ—Å—É—Ä—Å: `1056`
  - –¢–∞–±–µ–ª—å: `1060`

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è?

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ–Ω—ã**:
   - –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
   - –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ Bitrix24
   - `bitrix_id` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –¥–ª—è —Å–≤—è–∑–∏

2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤/—Ç–∞–±–µ–ª–µ–π**:
   - –°–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ Bitrix24
   - –ü—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ —Å–º–µ–Ω–µ —á–µ—Ä–µ–∑ `UF_SHIFT_ID`

3. **–ü–æ–∏—Å–∫ —Å–º–µ–Ω—ã**:
   - –°–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç—Å—è –≤ Bitrix24 (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—â–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î (fallback)

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ–Ω—ã
```python
# –í Bitrix24
shift_id = await bx_post("crm.item.add", {
    "entityTypeId": 1050,  # SHIFT_ETID
    "fields": {
        "TITLE": "–°–º–µ–Ω–∞ #123",
        "ufCrm7UfCrmDate": "2025-11-08T08:00:00",
        "ufCrm7UfCrmObject": ["D_9"],  # –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –æ–±—ä–µ–∫—Ç—É
        ...
    }
})
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–µ–ª—è
```python
# –í Bitrix24
timesheet_id = await bx_post("crm.item.add", {
    "entityTypeId": 1060,  # ENTITY_TIMESHEET
    "fields": {
        "TITLE": "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ1 / 8 —á",
        "ufCrm11UfShiftId": 12345,  # ID —Å–º–µ–Ω—ã
        "ufCrm11UfWorker": "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ1",
        "ufCrm11UfHours": 8.0,
        "ufCrm11UfRate": 600.0,
    }
})
```

---

## üõ† –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

- `app/services/bitrix_ids.py` ‚Äî ID —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –ø–æ–ª–µ–π Bitrix24
- `app/models.py` ‚Äî –ú–æ–¥–µ–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
- `bitrix_field_map.json` ‚Äî –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π Bitrix24
- `app/db.py` ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **Bitrix24 ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Bitrix24
2. **–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î ‚Äî –∫—ç—à**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: `bitrix_id` –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î —Å–≤—è–∑—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏
4. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤ –æ–±–µ–∏—Ö –ë–î –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏



