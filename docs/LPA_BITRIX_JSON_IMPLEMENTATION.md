# Реализация сохранения детальных данных в Bitrix24 для ЛПА

## Проблема
ЛПА заполнялся неверно, потому что детальные данные (`plan_json`, `fact_json`) сохранялись только в локальной БД, а в Bitrix24 - только итоговые значения (`plan_total`, `fact_total`).

## Решение
Теперь детальные данные сохраняются в Bitrix24 в JSON-полях, и ЛПА может их читать оттуда, если локальная БД недоступна.

## Что было сделано

### 1. Добавлены новые поля в Bitrix24
- **UF_PLAN_JSON** - "План работ (JSON)" (многострочный текст)
- **UF_FACT_JSON** - "Факт работ (JSON)" (многострочный текст)

### 2. Обновлен код сохранения плана (`app/telegram/flow_plan.py`)
- При создании смены в Bitrix24 теперь сохраняется `plan_json` в поле `UF_PLAN_JSON`
- Сохраняются все детальные данные: работы, их объемы, название объекта, дата, секция, прораб

### 3. Обновлен код сохранения отчета (`app/telegram/flow_report.py`)
- При сохранении отчета теперь сохраняется `fact_json` в поле `UF_FACT_JSON`
- Также обновляется `plan_json`, если план был изменен

### 4. Обновлен код генерации ЛПА (`app/telegram/flow_lpa.py`)
- Если смена не найдена в локальной БД, ЛПА пытается прочитать JSON из Bitrix24
- Если JSON найден, используются детальные данные из него
- Если JSON не найден, используются только итоговые значения (как раньше)

## Что нужно сделать в Bitrix24

1. Войдите в Bitrix24
2. Перейдите в настройки CRM → Смарт-процессы
3. Выберите смарт-процесс "Смена" (entityTypeId: 1050)
4. Нажмите "Настроить поля"
5. Добавьте два новых поля:

   **Поле 1:**
   - Название: "План работ (JSON)"
   - Тип: Многострочный текст
   - Обязательное: Нет

   **Поле 2:**
   - Название: "Факт работ (JSON)"
   - Тип: Многострочный текст
   - Обязательное: Нет

6. После создания полей запустите синхронизацию:
   ```bash
   python scripts/sync_bitrix_env.py
   ```

## Как это работает

1. **При создании плана:**
   - Бот собирает данные в чате
   - Сохраняет детальные данные в локальную БД (`plan_json`)
   - Создает смену в Bitrix24
   - Сохраняет `plan_json` в поле `UF_PLAN_JSON` в Bitrix24

2. **При сохранении отчета:**
   - Бот собирает фактические данные в чате
   - Сохраняет детальные данные в локальную БД (`fact_json`)
   - Обновляет смену в Bitrix24
   - Сохраняет `fact_json` в поле `UF_FACT_JSON` в Bitrix24

3. **При генерации ЛПА:**
   - Сначала ищет смену в локальной БД (приоритет - там самые полные данные)
   - Если не найдена, ищет в Bitrix24
   - Если найдена в Bitrix24, пытается прочитать JSON из полей `UF_PLAN_JSON` и `UF_FACT_JSON`
   - Если JSON найден, использует детальные данные из него
   - Если JSON не найден, использует только итоговые значения

## Преимущества

✅ ЛПА теперь всегда заполняется детальными данными из бота
✅ Данные сохраняются в Bitrix24, даже если локальная БД недоступна
✅ Обратная совместимость: если JSON нет, используются итоговые значения
✅ Автоматическое сохранение - не требует дополнительных действий от пользователя

## Тестирование

После добавления полей в Bitrix24 и синхронизации:

1. Создайте план через бота
2. Сохраните отчет через бота
3. Сгенерируйте ЛПА
4. Проверьте, что ЛПА заполнен детальными данными из бота

