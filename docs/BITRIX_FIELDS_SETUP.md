# Инструкция по добавлению полей в Bitrix24 SPA

## Новые поля для добавления

### Смена (entityTypeId: 1050)

1. **UF_DOWNTIME_REASON** (Причина простоя)
   - Тип: Многострочный текст
   - Название в Bitrix24: "Причина простоя"
   - Обязательное: Нет

2. **UF_SHIFT_PHOTOS** (Фото смены)
   - Тип: Файл (множественный)
   - Название в Bitrix24: "Фото смены"
   - Обязательное: Нет

3. **UF_PLAN_JSON** (План работ (JSON))
   - Тип: Многострочный текст
   - Название в Bitrix24: "План работ (JSON)"
   - Обязательное: Нет
   - Описание: Детальные данные плана работ в формате JSON (сохраняется автоматически ботом)

4. **UF_FACT_JSON** (Факт работ (JSON))
   - Тип: Многострочный текст
   - Название в Bitrix24: "Факт работ (JSON)"
   - Обязательное: Нет
   - Описание: Детальные данные фактических работ в формате JSON (сохраняется автоматически ботом)

### Ресурс (entityTypeId: 1056)

1. **UF_RES_COMMENT** (Комментарий к ресурсу)
   - Тип: Текст
   - Название в Bitrix24: "Комментарий к ресурсу"
   - Обязательное: Нет

2. **UF_RES_PHOTOS** (Фото ресурса)
   - Тип: Файл (множественный)
   - Название в Bitrix24: "Фото ресурса"
   - Обязательное: Нет

### Табель (entityTypeId: 1060)

1. **UF_TS_COMMENT** (Комментарий к табелю)
   - Тип: Текст
   - Название в Bitrix24: "Комментарий к табелю"
   - Обязательное: Нет

2. **UF_TS_PHOTOS** (Фото табеля)
   - Тип: Файл (множественный)
   - Название в Bitrix24: "Фото табеля"
   - Обязательное: Нет

## Шаги по добавлению полей

1. Войдите в Bitrix24
2. Перейдите в настройки CRM → Смарт-процессы
3. Выберите нужный смарт-процесс (Смена, Ресурс или Табель)
4. Нажмите "Настроить поля"
5. Добавьте каждое поле с указанными выше параметрами
6. **Важно**: Используйте точные названия полей, указанные выше (например, "Причина простоя", а не "Причина простоя смены")

## После создания полей

Запустите синхронизацию:

```bash
make sync-bitrix
```

Или напрямую:

```bash
python scripts/sync_bitrix_env.py
```

Скрипт автоматически:
- Обновит `bitrix_field_map.json` с новыми полями
- Найдет реальные коды полей (например, `UF_CRM_7_UF_DOWNTIME_REASON`)
- Сохранит их в маппинг для использования в коде

## Проверка синхронизации

После синхронизации проверьте файл `bitrix_field_map.json`:

```json
{
  "Смена": {
    "userfields": {
      "UF_CRM_7_UF_DOWNTIME_REASON": {
        "label": "Причина простоя",
        "type": "text"
      },
      "UF_CRM_7_UF_SHIFT_PHOTOS": {
        "label": "Фото смены",
        "type": "file"
      }
    }
  }
}
```

## Использование в коде

После синхронизации поля можно использовать через `resolve_code()`:

```python
from app.bitrix_field_map import resolve_code, upper_to_camel

# Получить код поля
f_downtime = resolve_code("Смена", "UF_DOWNTIME_REASON")
# Вернет: UF_CRM_7_UF_DOWNTIME_REASON

# Конвертировать в camelCase для API
f_downtime_camel = upper_to_camel(f_downtime)
# Вернет: ufCrm7UfDowntimeReason

# Использовать при создании/обновлении
await bx("crm.item.update", {
    "entityTypeId": 1050,
    "id": shift_id,
    "fields": {
        f_downtime_camel: "Простой из-за погоды"
    }
})
```



