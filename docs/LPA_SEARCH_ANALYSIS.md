# –ê–Ω–∞–ª–∏–∑ –ø–æ–∏—Å–∫–∞ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω –¥–ª—è –õ–ü–ê

## üîç –û—Ç–∫—É–¥–∞ –±–æ—Ç –±–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ

### 1. **Bitrix24 (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)**
–ë–æ—Ç –∏—â–µ—Ç —Å–º–µ–Ω—ã –≤ Bitrix24 –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:

#### –°–ø–æ—Å–æ–± 1: –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ –æ–±—ä–µ–∫—Ç—É (–Ω–æ–≤—ã–π, –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π)
- –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–º–µ–Ω –∏–∑ Bitrix24
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –∏—Ö –ø–æ –æ–±—ä–µ–∫—Ç—É (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª–µ `UF_OBJECT_LINK`)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã

#### –°–ø–æ—Å–æ–± 2: –ü–æ–∏—Å–∫ –ø–æ –¥–Ω—è–º (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥, fallback)
- –ò—â–µ—Ç —Å–º–µ–Ω—ã –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 –¥–Ω–µ–π
- –î–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å–º–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—ä–µ–∫—Ç
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ

### 2. **–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î SQLite (—Ä–µ–∑–µ—Ä–≤)**
–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ Bitrix24, –∏—â–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î:
- –§—É–Ω–∫—Ü–∏—è: `get_last_closed_shift(object_id)`
- –ò—â–µ—Ç —Å–º–µ–Ω—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `ShiftStatus.CLOSED`
- –ü—Ä–æ–±–ª–µ–º–∞: —Å–º–µ–Ω—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤ Bitrix24, –Ω–æ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î

## ‚ùå –ü–æ—á–µ–º—É –º–æ–∂–µ—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–º–µ–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –°–º–µ–Ω—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
- –°–º–µ–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ Bitrix24
- –ù–æ –Ω–µ –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
- –†–µ—à–µ–Ω–∏–µ: –∏—Å–∫–∞—Ç—å –≤ Bitrix24 (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- –†–∞–Ω—å—à–µ: —Å–º–µ–Ω–∞ —Å—á–∏—Ç–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã—Ç–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å = "closed" –∏–ª–∏ –ø—É—Å—Ç–æ–π –ò –µ—Å—Ç—å —Ñ–∞–∫—Ç
- –¢–µ–ø–µ—Ä—å: —Å–º–µ–Ω–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–∫—Ä—ã—Ç–æ–π –µ—Å–ª–∏:
  - –°—Ç–∞—Ç—É—Å = "closed"/"–∑–∞–∫—Ä—ã—Ç–∞"/"–∑–∞–∫—Ä—ã—Ç–æ" –ò–õ–ò
  - –°—Ç–∞—Ç—É—Å –ø—É—Å—Ç–æ–π/None –ò –µ—Å—Ç—å —Ñ–∞–∫—Ç –ò–õ–ò
  - –°—Ç–∞—Ç—É—Å –Ω–µ "open" –ò –µ—Å—Ç—å —Ñ–∞–∫—Ç

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –æ–±—ä–µ–∫—Ç–∞
- Bitrix24 –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—ä–µ–∫—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ `"D_1046"` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `"1046"`
- –ö–æ–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–¥—ã –ø–æ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `resolve_code()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–æ–≤ –ø–æ–ª–µ–π
- –ü—Ä–æ–±—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: camelCase –∏ UPPER_CASE

## üîß –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ –æ–±—ä–µ–∫—Ç—É (–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π)
2. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ–π —Å–º–µ–Ω—ã
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
4. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω –ø—Ä–∏ –ø—Ä—è–º–æ–º –ø–æ–∏—Å–∫–µ

## üìù –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```powershell
   Get-Content bot.log | Select-String "\[LPA\]" | Select-Object -Last 50
   ```

2. –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
   - `[LPA] Trying direct search by object X`
   - `[LPA] Found N shifts for object X`
   - `[LPA] Shift X: obj=Y, plan=Z, fact=W, status='...'`
   - `[LPA] ‚úÖ Found closed shift` –∏–ª–∏ `[LPA] Skipping shift`

3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Skipping shift", –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - –ï—Å—Ç—å –ª–∏ `fact_total > 0`?
   - –ö–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã?
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –æ–±—ä–µ–∫—Ç?

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ï—Å–ª–∏ –±–æ—Ç –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–º–µ–Ω—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —Å–º–µ–Ω—ã –≤ Bitrix24 –¥–ª—è –æ–±—ä–µ–∫—Ç–∞:
   - –û—Ç–∫—Ä–æ–π—Ç–µ Bitrix24
   - –ù–∞–π–¥–∏—Ç–µ —Å–º–µ–Ω—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —É –Ω–∏—Ö `UF_FACT_TOTAL > 0`

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫:
   ```powershell
   Get-Content bot.log | Select-String "\[LPA\].*Error|Exception" | Select-Object -Last 20
   ```

3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –∏–∑ —Å–≤–æ–¥–∫–∏:
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Å–≤–æ–¥–∫—É (`/daily_report`)
   - –ù–∞–∂–º–∏—Ç–µ "üìÑ –õ–ü–ê –¥–ª—è —Å–º–µ–Ω—ã #X"
   - –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ ID —Å–º–µ–Ω—ã


